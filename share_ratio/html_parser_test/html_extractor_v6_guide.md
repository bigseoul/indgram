# `html_extractor_v6.py` 추출 전략 및 방법 가이드

`html_extractor_v6.py`는 복잡한 HTML 문서(주로 기업 공시 레포트)에서 **지분율 관련 데이터**를 LLM이 처리하기 가장 적합한 형태로 압축하여 추출하는 것을 목적으로 합니다.

## 1. 핵심 추출 전략 (Core Strategies)

### 1.1 토큰 사용량 극한의 최소화 (Token Optimization)
LLM의 입력 비용을 줄이고 Context Window 효율을 높이기 위해 HTML 구조를 압축합니다.
- **태그 축약 (`TAG_MAP`):** `<table>` → `<t>`, `<tr>` → `<r>`, `<td>` → `<d>` 등 표준 태그를 1~2글자로 치환합니다.
- **속성 축약 (`ATTR_MAP`):** `colspan` → `c`, `rowspan` → `r`로 치환하여 표 구조는 유지하되 길이는 줄입니다.
- **불필요한 데이터 제거:** 주석 패턴(`(*1)`, `[주1]`) 및 지분 분석에 불필요한 스타일 정보, 빈 태그 등을 사전 제거합니다.

### 1.2 타겟팅 추출 (Targeted Extraction)
문서 전체를 보내는 대신, 실제 데이터가 포함된 구역만 선별합니다.
- **패턴 매칭:** `%` 기호 또는 `"지분율"`이라는 텍스트가 포함된 `<table>` 혹은 `<p>`, `<div>` 블록을 우선적으로 탐색합니다.
- **중복 방지:** 이미 추출된 표의 자식 요소들이 중복으로 추출되지 않도록 `seen_elements` 세트를 사용하여 관리합니다.

### 1.3 문맥 보존 (Context Preservation)
단순히 표만 추출하면 해당 표가 무엇을 의미하는지 알기 어렵기 때문에 관련 문맥을 함께 추출합니다.
- **섹션 타이틀 매칭:** 해당 데이터가 속한 상위 목차(예: `3. 연결재무제표 주석`)를 역추적하여 기록합니다.
- **인접 문구 추출:** 표 바로 직전에 위치한 1~2개의 단락(주로 표의 제목이나 설명)을 `[C]`(Context) 블록으로 묶어 함께 제공합니다.

---

## 2. 주요 메서드 설명 (Key Methods)

### `extract_evidence_blocks(soup)`
추출 프로세스를 총괄하는 **메인 오케스트레이터**입니다.
1. `_get_company_name`, `_extract_global_meta`를 통해 기업명, 단위(천원 등), 기준 일자를 먼저 파악합니다.
2. 문서 내의 모든 태그를 순회하며 `RATIO_PATTERN`(% 또는 지분율)이 포함된 요소를 찾습니다.
3. 표(`table`)인 경우 `_get_preceding_context`를 통해 주변 설명을 가져오고, 내용을 압축하여 `[TBL]` 블록으로 생성합니다.
4. 일반 텍스트인 경우 `[TXT]` 블록으로 생성합니다.

### `_get_simplified_html(tag)`
HTML 태그를 압축된 형태의 문자열로 변환하는 **재귀 메서드**입니다.
- 태그 이름과 속성을 매핑 테이블에 따라 변환합니다.
- 내부 텍스트는 `_clean_text`를 통해 주석이 제거된 깨끗한 상태로 유지됩니다.

### `_get_section_title(tag)`
현재 데이터가 어떤 항목에 속해 있는지 식별하기 위해 **DOM 역탐색**을 수행합니다.
- 정규식(`r"^\s*([0-9]{1,2}|[IVX]{1,3}|[가-하])[\.)\s]+"`)을 사용하여 목차 형태의 텍스트를 찾아 반환합니다.

### `_clean_text(text)`
텍스트 데이터의 **노이즈를 제거**합니다.
- `FOOTNOTE_PATTERN`: `(*1)`, `(주1)`, `*1`, `[1]` 등 재무제표 특유의 주석 표기를 제거하여 수치 데이터 인식 오류를 방지합니다.

---

## 3. 출력 포맷 (Output Structure)

결과물은 아래와 같은 커스텀 마크업 구조를 가집니다.

```text
[META]
C: 주식회사 큐로홀딩스
U: 천원
D: 2024년 12월 31일
---
[TBL]
[S: 1. 연결회사의 개요]
<t><thead><r><h r="2">주주명</h> ...
---
[TXT]
[S: 1. 연결회사의 개요]
<p>지배기업의 주요 주주의 구성내역은 다음과 같습니다.</p>
```

- **`[META]`**: 문서 전체의 메타데이터.
- **`[TBL]` / `[TXT]`**: 데이터 타입 구분.
- **`[S: ...]`**: 해당 데이터의 섹션 위치.
- **`---`**: 개별 증거 블록 간의 구분자.
